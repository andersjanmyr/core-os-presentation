<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <title>core-os</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"/>

  <link rel="stylesheet" href=".//css/reset.css" type="text/css"/>

  

  <link type="text/css" href=".//css/fg.menu.css" media="screen" rel="stylesheet" />
  <link type="text/css" href=".//css/theme/ui.all.css" media="screen" rel="stylesheet" />
  <link type="text/css" href=".//css/sh_style.css" rel="stylesheet" />
  <link type="text/css" href=".//css/tipsy.css" rel="stylesheet" />

  <link rel="stylesheet" href=".//css/showoff.css" type="text/css"/>

  <script type="text/javascript" src=".//js/jquery-1.4.2.min.js"></script>
  <script type="text/javascript" src=".//js/jquery.cycle.all.js"></script>
	<script type="text/javascript" src=".//js/jquery-print.js"></script>
  <script type="text/javascript" src=".//js/jquery.batchImageLoad.js"></script>
  <script type="text/javascript" src=".//js/jquery.parsequery.min.js"></script>
  <script type="text/javascript" src=".//js/jquery.doubletap-0.1.js"></script>
  <script type="text/javascript" src=".//js/jquery.tipsy.js"></script>

  <script type="text/javascript" src=".//js/fg.menu.js"></script>
  <script type="text/javascript" src=".//js/showoff.js"></script>
  <script type="text/javascript" src=".//js/jTypeWriter.js"> </script>
  <script type="text/javascript" src=".//js/sh_main.min.js"></script>
  <script type="text/javascript" src=".//js/core.js"></script>
  <script type="text/javascript" src=".//js/showoffcore.js"></script>
  <script type="text/javascript" src=".//js/coffee-script.js"></script>

  
    
      <script type="text/javascript" src=".//js/sh_lang/sh_ruby.min.js"></script>
    
      <script type="text/javascript" src=".//js/sh_lang/sh_ini.min.js"></script>
    
      <script type="text/javascript" src=".//js/sh_lang/sh_sh.min.js"></script>
    
  

  
    
    <link rel="stylesheet" href=".//file/jayway.css" type="text/css"/>
  

  

  <script type="text/javascript">
    $(function(){
      setupPreso(false, './');
    });

    editUrl  = "";
  </script>

</head>

<body>

<a tabindex="0" href="#search-engines" class="fg-button fg-button-icon-right ui-widget ui-state-default ui-corner-all" id="navmenu"><span class="ui-icon ui-icon-triangle-1-s"></span>slides</a>
<div id="navigation" class="hidden"></div>
<a tabindex="1" href="#search-engines" class="fg-button fg-button-icon-right ui-widget ui-state-default ui-corner-all" id="stylemenu"><span class="ui-icon ui-icon-triangle-1-s"></span>styles</a>
<div id="stylepicker" class="hidden"></div>


<div id="help">
  <table>
    <tr><td class="key">z, ?</td><td>toggle help (this)</td></tr>
    <tr><td class="key">space, &rarr;</td><td>next slide</td></tr>
    <tr><td class="key">shift-space, &larr;</td><td>previous slide</td></tr>
    <tr><td class="key">b</td><td>blank screen</td></tr>
    <tr><td class="key">d</td><td>toggle debug mode</td></tr>
    <tr><td class="key">## &lt;ret&gt;</td><td>go to slide #</td></tr>
    <tr><td class="key">c, t</td><td>table of contents (vi)</td></tr>
    <tr><td class="key">f</td><td>toggle footer</td></tr>
    <tr><td class="key">g</td><td>toggle follow</td></tr>
    <tr><td class="key">r</td><td>reload slides</td></tr>
    <tr><td class="key">n</td><td>toggle notes</td></tr>
    <tr><td class="key">p</td><td>run preshow</td></tr>
    <tr><td class="key">P</td><td>toggle pause</td></tr>
    <tr><td class="key">s</td><td>choose style</td></tr>
  </table>
</div>

<div class="buttonNav">
  <input type="submit" onClick="prevStep();" value="prev"/>
  <input type="submit" onClick="nextStep();" value="next"/>
</div>

<div id="preso"><center>loading presentation...</center></div>
<div id="footer">
  <span id="followMode"></span>
  <span id="slideInfo"></span>
  <span id="debugInfo"></span>
  <span id="notesInfo"></span>
  <span id="slideFilename"></span>
  <img id="disconnected" src=".//css/disconnected.png" />
</div>

<div id="slides" class="offscreen" style="display:none;">
<div id="slides_01_intro" class="slide center" data-transition="none">
<div class="content center" ref="slides/01_intro/1">
<p><img src="./file/slides/coreos.png" alt=""></p>

<h3><a href="mailto:anders.janmyr@jayway.com">anders.janmyr@jayway.com</a></h3>

<h3><a href="http://anders.janmyr.com">http://anders.janmyr.com</a></h3>

<h3>@andersjanmyr</h3>
</div>
</div>
<div id="slides_01_intro" class="slide bullets small" data-transition="none">
<div class="content bullets small" ref="slides/01_intro/2">
<h1>Core OS Why?</h1>

<ul>
<li>Automatically add new machines to the cluster</li>
<li>Discover machines running in the cluster</li>
<li>Deploy docker containers on arbitrary hosts in a cluster</li>
<li>Distribute services across a cluster</li>
<li>Multiple instances of a service, re-schedule on failure</li>
<li>Automatically SSH into the machine running a job</li>
</ul>
</div>
</div>
<div id="slides_01_intro" class="slide center" data-transition="none">
<div class="content center" ref="slides/01_intro/3">
<h1>Core OS Components</h1>

<p><img src="./file/slides/coreos-components.png" alt=""></p>
</div>
</div>
<div id="slides_01_intro" class="slide center" data-transition="none">
<div class="content center" ref="slides/01_intro/4">
<h1>Core OS Linux distro</h1>

<p><img src="./file/slides/host-diagram.png" alt=""></p>
</div>
</div>
<div id="slides_01_intro" class="slide bullets" data-transition="none">
<div class="content bullets" ref="slides/01_intro/5">
<h1>Core OS Linux distro</h1>

<ul>
<li>Minimal 114MB RAM on boot</li>
<li>No package manager, Docker</li>
<li>Dual-partition scheme

<ul>
<li>Read-only boot partitions</li>
<li>Upgrade to passive partition</li>
<li>Safe Roll Back</li>
</ul>
</li>
<li>Managed Linux</li>
</ul>
</div>
</div>
<div id="slides_01_intro" class="slide code small" data-transition="none">
<div class="content code small" ref="slides/01_intro/6">
<h1>Core OS, user-data</h1>

<pre class="sh_ruby"><code>coreos:
  etcd:
    # generate new token for cluster
    # https://discovery.etcd.io/new
    discovery: https://discovery.etcd.io/&lt;token&gt;
    # multi-cloud deployments need to use $public_ipv4
    addr: $private_ipv4:4001
    peer-addr: $private_ipv4:7001
  units:
    - name: etcd.service
      command: start
    - name: fleet.service
      command: start
 fleet:
    - public-ip: $public_ipv4
    - metadata: region=us-east-1,disk=ssd,model=m3.2xlarge</code></pre>
</div>
</div>
<div id="slides_01_intro" class="slide center" data-transition="none">
<div class="content center" ref="slides/01_intro/7">
<h1>Docker</h1>

<p><img src="./file/slides/docker.png" alt=""></p>
</div>
</div>
<div id="slides_01_intro" class="slide bullets small" data-transition="none">
<div class="content bullets small" ref="slides/01_intro/8">
<h1>Docker</h1>

<ul>
<li>Containers isolates an application's view of the OS</li>
<li>CPU, memory, block I/O, network</li>
<li>Lightweight VM</li>
<li>No separate OS</li>
<li>An interface between Dev and Ops</li>
</ul>
</div>
</div>
<div id="slides_01_intro" class="slide bullets, small" data-transition="none">
<div class="content bullets, small" ref="slides/01_intro/9">
<h1>systemd</h1>

<ul>
<li>Performance, boots extremely fast, goal is under 1s</li>
<li>Journal, logging journal has modern features

<ul>
<li>JSON export</li>
<li>Forward secure sealing</li>
<li>Indexing for fast querying</li>
</ul>
</li>
<li>Socket Activation, no need to start a service until it is used</li>
<li>Systemd is well supported in many Linux distros</li>
</ul>
</div>
</div>
<div id="slides_01_intro" class="slide code small" data-transition="none">
<div class="content code small" ref="slides/01_intro/10">
<h1>systemd, unit-file</h1>

<pre class="sh_ini"><code>[Unit]
Description=MyApp
After=docker.service
Requires=docker.service

[Service]
TimeoutStartSec=0
ExecStartPre=-/usr/bin/docker kill busybox1
ExecStartPre=-/usr/bin/docker rm busybox1
ExecStartPre=/usr/bin/docker pull busybox
ExecStart=/usr/bin/docker run --name busybox1 busybox \
  /bin/sh -c "while true; do echo Hello World; sleep 1; done"</code></pre>
</div>
</div>
<div id="slides_01_intro" class="slide code small" data-transition="none">
<div class="content code small" ref="slides/01_intro/11">
<h1>systemd, servicectl</h1>

<pre class="sh_sh"><code># Enable and start the service
$ sudo systemctl enable /etc/systemd/system/hello.service
$ sudo systemctl start hello.service

# Read the logs
$ journalctl -f -u hello.service
$ docker ps
$ docker logs &lt;container_id&gt;</code></pre>
</div>
</div>
<div id="slides_01_intro" class="slide bullets center small" data-transition="none">
<div class="content bullets center small" ref="slides/01_intro/12">
<p><img src="./file/slides/etcd.png" alt=""></p>

<ul>
<li><p><code>etcd</code> is a distributed, consistent key value store for shared configuration and
service discovery</p></li>
<li><p><code>etcd</code> is written in Go and uses the Raft consensus algorithm to manage a
highly-available replicated log</p></li>
</ul>
</div>
</div>
<div id="slides_01_intro" class="slide bullets, small" data-transition="none">
<div class="content bullets, small" ref="slides/01_intro/13">
<h1>etcd</h1>

<ul>
<li>Simple: curl'able user facing API (HTTP+JSON)</li>
<li>Secure: optional SSL client cert authentication</li>
<li>Fast: benchmarked 1000s of writes/s per instance</li>
<li>Reliable: properly distributed using Raft</li>
</ul>
</div>
</div>
<div id="slides_01_intro" class="slide code small" data-transition="none">
<div class="content code small" ref="slides/01_intro/14">
<h1>etcdctl</h1>

<pre class="sh_sh"><code># Set a value that expires after 60s
# Also creates dir /foo is it does not exist
$ etcdctl set /foo/bar "Hello world" --ttl 60
Hello world

# Get a value
$ etcdctl get /foo/bar
Hello world

# Update a value, if it exists
$ etcdctl update /foo/bar
Hello world

$ etcdctl update /foo/missing dingo
Error:  100: Key not found (/foo/missing) [45034]

# Remove a value
$ etcdctl rm /foo/bar</code></pre>
</div>
</div>
<div id="slides_01_intro" class="slide code small" data-transition="none">
<div class="content code small" ref="slides/01_intro/15">
<h1>etcdctl ls</h1>

<pre class="sh_sh"><code># List a directory
$ etcdctl ls /foo
/foo/bar
/foo/car

# List a directory recursively
$ etcdctl ls --recursive /
/coreos.com
/coreos.com/updateengine
/coreos.com/updateengine/rebootlock
/coreos.com/updateengine/rebootlock/semaphore
/foo/bar
/foo/car</code></pre>
</div>
</div>
<div id="slides_01_intro" class="slide code small" data-transition="none">
<div class="content code small" ref="slides/01_intro/16">
<h1>etcdctl watch</h1>

<pre class="sh_sh"><code># Watch a key for changes
$ etcdctl watch /foo/bar
Hello world

$ etcdctl exec-watch /foo/bar -- sh -c "env | grep ETCD"
ETCD_WATCH_ACTION=set
ETCD_WATCH_VALUE=Dingo
ETCD_WATCH_MODIFIED_INDEX=1999
ETCD_WATCH_KEY=/foo/bar

ETCD_WATCH_ACTION=delete
ETCD_WATCH_VALUE=
ETCD_WATCH_MODIFIED_INDEX=2000
ETCD_WATCH_KEY=/foo/bar</code></pre>
</div>
</div>
<div id="slides_01_intro" class="slide bullets" data-transition="none">
<div class="content bullets" ref="slides/01_intro/17">
<h1>fleet</h1>

<ul>
<li>Cluster manager</li>
<li>Extension of <code>systemd</code>
</li>
<li>Uses <code>etcd</code> for configuration</li>
<li>On every Core OS machine</li>
</ul>
</div>
</div>
<div id="slides_01_intro" class="slide code small" data-transition="none">
<div class="content code small" ref="slides/01_intro/18">
<h1>fleetctl list-machines</h1>

<pre class="sh_sh"><code>$ fleetctl list-machines
MACHINE                                 IP          METADATA
148a18ff-6e95-4cd8-92da-c9de9bb90d5a    10.10.1.1   -
491586a6-508f-4583-a71d-bfc4d146e996    10.10.1.2   -
c9de9451-6a6f-1d80-b7e6-46e996bfc4d1    10.10.1.3   -</code></pre>
</div>
</div>
<div id="slides_01_intro" class="slide code small" data-transition="none">
<div class="content code small" ref="slides/01_intro/19">
<h1>fleetctl list-units</h1>

<pre class="sh_sh"><code>$ fleetctl list-units
UNIT               MACHINE                    ACTIVE   SUB
apache@1.service   52bd1b3d.../172.17.8.103   active   running
apache@2.service   84c58228.../172.17.8.102   active   running
myapp.service      52bd1b3d.../172.17.8.103   active   running</code></pre>
</div>
</div>
<div id="slides_01_intro" class="slide code small" data-transition="none">
<div class="content code small" ref="slides/01_intro/20">
<h1>fleet, unit-file etcd</h1>

<pre class="sh_ini"><code>[Unit]
Description=sinatra

[Service]
EnvironmentFile=/etc/environment
ExecStartPre=/usr/bin/docker pull marceldegraaf/sinatra
ExecStart=/usr/bin/docker run --name sinatra-%i --rm \
  -p %i:5000 -e PORT=5000 marceldegraaf/sinatra
ExecStartPost=/usr/bin/etcdctl set /app/server/%i \
  ${COREOS_PUBLIC_IPV4}:%i
ExecStop=/usr/bin/docker kill sinatra-%i
ExecStopPost=/usr/bin/etcdctl rm /app/server/%i

[X-Fleet]
Conflicts=sinatra@%i.service</code></pre>
</div>
</div>
<div id="slides_01_intro" class="slide code small" data-transition="none">
<div class="content code small" ref="slides/01_intro/21">
<h1>fleetctl start</h1>

<pre class="sh_sh"><code>$ fleetctl start sinatra@1.service
$ fleetctl start sinatra@2.service</code></pre>
</div>
</div>
<div id="slides_01_intro" class="slide code small" data-transition="none">
<div class="content code small" ref="slides/01_intro/22">
<h1>fleet, unit-file no etcd</h1>

<pre class="sh_ini"><code>[Unit]
Description=Nginx
After=docker.service
Requires=docker.service

[Service]
TimeoutStartSec=0
ExecStartPre=/usr/bin/docker pull nginx
ExecStart=/usr/bin/docker run --rm --name nginx -p 80:80 nginx
ExecStop=/usr/bin/docker stop nginx

[X-Fleet]
Conflicts=nginx@*.service</code></pre>
</div>
</div>
<div id="slides_01_intro" class="slide code small" data-transition="none">
<div class="content code small" ref="slides/01_intro/23">
<h1>fleet, unit-file sidekick</h1>

<pre class="sh_ini"><code>[Unit]
Description=Nginx sidekick
BindsTo=nginx@%i.service
After=nginx@%i.service

[Service]
ExecStart=/bin/sh -c "while true; do etcdctl set
/services/website/nginx@%i '{ \"host\": \"%H\", \"port\": 80,
  \"version\": \"52c7248a14\" }' --ttl 60;sleep 45;done"
ExecStop=/usr/bin/etcdctl rm /services/website/nginx@%i

[X-Fleet]
MachineOf=nginx@%i.service</code></pre>
</div>
</div>
<div id="slides_01_intro" class="slide code small" data-transition="none">
<div class="content code small" ref="slides/01_intro/24">
<h1>fleet-specific properties</h1>

<pre class="sh_sh"><code># Valid properties
MachineID       = 'Schedule on specific machine'
MachineOf       = 'On a machine that has the unit'
Conflicts       = 'NOT on a machine that has the unit'
MachineMetadata = 'Schedula based on metadata'
Global          = 'If true, on all machines
                   according to MachineMetadata'

# Unit patterns string.suffix or string@instance.suffix
string   = 'Alphanumeric chararters, dash and underscore'
instance = 'Can be empty, otherwise same as string'
suffix   = 'One of service, socket, device, mount,
            automount, timer, path'</code></pre>
</div>
</div>
<div id="slides_01_intro" class="slide code small" data-transition="none">
<div class="content code small" ref="slides/01_intro/25">
<h1>fleet, unit-file global</h1>

<pre class="sh_ini"><code># datadog.service
[Unit]
Description=Datadog Service

[Service]
TimeoutStartSec=0
ExecStartPre=-/usr/bin/docker kill dd-agent
ExecStartPre=-/usr/bin/docker rm dd-agent
ExecStartPre=/usr/bin/docker pull datadog/docker-dd-agent
ExecStart=/usr/bin/bash -c \
"/usr/bin/docker run --privileged --name dd-agent \
-h `hostname` \
-v /var/run/docker.sock:/var/run/docker.sock \
-v /proc/mounts:/host/proc/mounts:ro \
-v /sys/fs/cgroup/:/host/sys/fs/cgroup:ro \
-e API_KEY=`etcdctl get /ddapikey` \
datadog/docker-dd-agent"

[X-Fleet]
Global=true</code></pre>
</div>
</div>
<div id="slides_01_intro" class="slide code small" data-transition="none">
<div class="content code small" ref="slides/01_intro/26">
<h1>fleetctl, start, list-units</h1>

<pre class="sh_sh"><code>$ fleetctl start datadog.service
$ fleetctl list-units
UNIT                        MACHINE                 ACTIVE    SUB
myapp.service               c9de9451.../10.10.1.3   active    running
apache@1.service            491586a6.../10.10.1.2   active    running
apache@2.service            148a18ff.../10.10.1.1   active    running
apache-discovery@1.service  491586a6.../10.10.1.2   active    running
apache-discovery@2.service  148a18ff.../10.10.1.1   active    running
datadog.service             148a18ff.../10.10.1.1   active    running
datadog.service             491586a6.../10.10.1.2   active    running
datadog.service             c9de9451.../10.10.1.3   active    running</code></pre>
</div>
</div>
<div id="slides_01_intro" class="slide code small" data-transition="none">
<div class="content code small" ref="slides/01_intro/27">
<h1>fleetctl, status</h1>

<pre class="sh_sh"><code>$ fleetctl status hello.service
hello.service - Hello World
   Loaded: loaded (/run/systemd/system/hello.service;
   Active: active (running) since Wed 2014-01-29 23:20:23
 Main PID: 6973 (bash)
   CGroup: /system.slice/hello.1.service
           ├─ 6973 /bin/bash -c while true; do echo "Hello, world"; sleep 1; done
           └─20381 sleep 1</code></pre>
</div>
</div>
<div id="slides_01_intro" class="slide code small" data-transition="none">
<div class="content code small" ref="slides/01_intro/28">
<h1>fleetctl, journal</h1>

<pre class="sh_sh"><code>fleetctl journal hello.service
-- Logs begin at Thu 2014-08-21 18:27:04 UTC, end at Thu 2014-08-21
19:07:38 UTC. --
Aug 21 19:07:38 core-03 bash[1127]: Hello, world</code></pre>
</div>
</div>
<div id="slides_01_intro" class="slide bullets small" data-transition="none">
<div class="content bullets small" ref="slides/01_intro/29">
<h1>confd</h1>

<ul>
<li>Lightweight configuration management tool</li>
<li>Keeps configuration files up-to-date</li>
<li>Works with etcd, consul, environment-vars</li>
<li>Reloads application on changes</li>
</ul>
</div>
</div>
<div id="slides_01_intro" class="slide code small" data-transition="none">
<div class="content code small" ref="slides/01_intro/30">
<h1>confd, nginx.toml</h1>

<pre class="sh_ini"><code># /etc/confd/conf.d/nginx.toml
[template]
# The name of the template
# Confd will look in `/etc/conf.d/templates`
src = "nginx.tmpl"

# The location to place the rendered configuration file
dest = "/etc/nginx/sites-enabled/app.conf"

# The etcd keys or directory to watch
keys = [ "/services/nodejs" ]

# File ownership and mode information
owner = "root"
mode = "0644"

# Commands
check_cmd = "/usr/sbin/nginx -t"
reload_cmd = "/usr/sbin/service nginx reload"</code></pre>
</div>
</div>
<div id="slides_01_intro" class="slide code small" data-transition="none">
<div class="content code small" ref="slides/01_intro/31">
<h1>confd, nginx.tmpl</h1>

<pre class="sh_sh"><code>upstream nodejs_pool {
  {{ range $server := .services_nodejs }}
      server {{ $server.Value }};
  {{ end }}
}

# Will produce
upstream nodejs_pool {
    server server_1_IP:port_num;
    server server_2_IP:port_num;
    server server_3_IP:port_num;
}</code></pre>
</div>
</div>
<div id="slides_01_intro" class="slide code small" data-transition="none">
<div class="content code small" ref="slides/01_intro/32">
<h1>nginx start script</h1>

<pre class="sh_sh"><code>#!/bin/bash
# conf.d watch script

ETCD=127.0.0.1:4001
CONF=/etc/confd/conf.d/nginx.toml

# Try to make initial configuration every 5 seconds
until confd -onetime -node $ETCD -config-file $CONF; do
    sleep 5
done

# Start a polling `confd` process in the background
confd -interval 10 -node $ETCD -config-file $CONF &amp;

# Start the Nginx service using the generated config
service nginx start

# Follow the logs to allow the script to continue running
tail -f /var/log/nginx/*.log</code></pre>
</div>
</div>
<div id="slides_01_intro" class="slide code small" data-transition="none">
<div class="content code small" ref="slides/01_intro/33">
<h1>unit-file, confd</h1>

<pre class="sh_ini"><code>[Unit]
Description=Nginx Load Balancer

# Get CoreOS environmental variables
EnvironmentFile=/etc/environment

# Pre-start and Start
## Directives with "=-" are allowed to fail without consequence
ExecStartPre=-/usr/bin/docker kill nginx_lb
ExecStartPre=-/usr/bin/docker rm nginx_lb
ExecStartPre=/usr/bin/docker pull user_name/nginx_lb
ExecStart=/usr/bin/docker run --name nginx_lb \
  -p ${COREOS_PUBLIC_IPV4}:80:80 \
  user_name/nginx_lb /usr/local/bin/confd-watch
# Stop
ExecStop=/usr/bin/docker stop nginx_lb

[X-Fleet]
X-Conflicts=nginx.service
X-Conflicts=node@*.service</code></pre>
</div>
</div>
<div id="slides_99_summary" class="slide center" data-transition="none">
<div class="content center" ref="slides/99_summary/1">
<h1>Core OS Summary</h1>

<p><img src="./file/slides/coreos-components.png" alt=""></p>
</div>
</div>
<div id="slides_99_summary" class="slide bullets small" data-transition="none">
<div class="content bullets small" ref="slides/99_summary/2">
<h1>Slides</h1>

<ul>
<li><a href="http://andersjanmyr.github.io/core-os-presentation/">http://andersjanmyr.github.io/core-os-presentation/</a></li>
</ul>
</div>
</div>
<div id="slides_99_summary" class="slide " data-transition="none">
<div class="content " ref="slides/99_summary/3">
<h1>Questions?</h1>

<h3><a href="mailto:anders.janmyr@jayway.com">anders.janmyr@jayway.com</a></h3>

<h3><a href="http://anders.janmyr.com">http://anders.janmyr.com</a></h3>

<h3>@andersjanmyr</h3>
</div>
</div>
</div>
<div id="pauseScreen">
  PAUSED
</div>

</body>
</html>
